#!/usr/bin/env bash


readonly usage="Usage: $0 <config> [target] [script]"

set -euo pipefail

# paths specified in the config are relative to the config file
# unless they start with a / in which case they relative to the
# git repository root.
declare repo_root config config_dir


main(){
        local config_file script_file target target_dir
        case "$#" in
                3) script_file="$3" ;&
                2) target="$2" ;&
                1) config_file="$1" ;;
                *) die "$usage"
        esac

        [[ -f "$config_file" ]] || die NO_CONFIG_FILE "$config_file"

        config="$(cat "$config_file")"
        config_dir="$(dirname "$config_file")"
        repo_root="$(git rev-parse --show-toplevel)"

        [[ -n ${script_file:-} ]] ||
                script_file=$(path_from_config .script 'source script')

        [[ -f "$script_file" ]] || die NO_SCRIPT_FILE "$script_file"

        [[ -n ${target:-} ]] ||
                target=$(path_from_config .target target)

        case "$target" in
        *.app|*.scpt)
                target_dir="$(dirname "$target")"
                ;;
        *)
                # target is the directory to put the bundle in
                local basename
                basename="$(
                        config_property .name | grep .
                )" || die NO_NAME
                target_dir="$target"
                target="$target_dir/$basename.app"
                ;;
        esac

        mkdir -p "$target_dir" || die CANT_MKDIR "$target_dir"

        compile_file "$script_file" "$target"

        if [[ "$target" == *.app ]]
        then
                build_plist "$target/Contents/Info.plist"
                codesign --force --deep --sign - "$target"
        fi
}

compile_file(){ local script_file="$1" target="$2"

        local osa_language
        case "${script_file##*.}" in
        jxa|js) osa_language=JavaScript ;;
        applescript) osa_language=AppleScript ;;
        *) die BAD_SCRIPT_EXTENSION "${script_file##*.}"
        esac

        jq -r '.inline[]?' <<<"$config" | cat - "$script_file" |
        osacompile -l "$osa_language" -o "$target"
}




base_plist(){ local plist="$1"
        # this uses the plist generated by osacompile as a base
        [[ -f "$plist" ]] || die NO_PLIST "$plist"
        plutil -convert json -o - "$plist"
}

build_plist(){ local plist="$1"

        # temp=$(mktemp -t ca.heckman.osascript-bundler) || die CANT_MKTEMP
        # trap 'rm -f "$temp"' EXIT
jq --argjson map '{
        "name": "CFBundleName",
        "identifier": "CFBundleIdentifier",
        "version": "CFBundleShortVersionString",
        "copyright": "NSHumanReadableCopyright",
        "shortName": "CFBundleName",
        "shortVersion": "CFBundleShortVersionString",
        "longVersion": "CFBundleVersion"
}' '
((input) * (.plist // {})) * (
    with_entries(select(.key | in($map)) | .key = $map[.key])
)
' - <(base_plist "$plist") <<<"$config" |
        plutil -convert xml1 -o "$plist" - || die CANT_MKPLIST

}

config_property(){
        jq -r "$1" <<<"$config"
}

path_from_config(){ property="$1" name="$2"
        path="$(config_property "$property" | grep .
        )" || die NO_PROPERTY "$name"

        if [[ $path == /* ]]
        then echo "${repo_root}${path}"
        else echo "${config_dir}/${path}"
        fi
}

readonly -A fatalities=(
        [NO_CONFIG_FILE]='11:Config file not found: %s'
        [NO_SCRIPT_FILE]='12:Script file not found: %s'
        [NO_PROPERTY]='13:No %s specified'
        [NO_NAME]='14:No bundle name specified'
        [CANT_MKDIR]='15:Cannot create target directory: %s'
        [NO_PLIST]='16:No plist found: %s'
        [CANT_MKTEMP]='17:Cannot create temporary file'
        [CANT_MKPLIST]='18:Cannot create plist'
        [CANT_MERGE_PLISTS]='19:Cannot merge plist'
        [BAD_SCRIPT_EXTENSION]='20:Unknown script extension: %s'
)
die(){
        local fatality="${fatalities[$1]:-1:$1}"
        shift
        # shellcheck disable=SC2059  # variable format
        printf "Error: ${fatality#*:}" "$@" >&2
        exit "${fatality%%:*}"
}

main "$@"
